package spider;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.nio.charset.Charset;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.Iterator;
import java.util.List;

import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.ContentType;
import org.apache.http.impl.client.HttpClientBuilder;
import org.jsoup.Connection;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import java.sql.ResultSet;
import java.sql.Timestamp;
import java.sql.PreparedStatement;
import java.sql.DriverManager;
import java.sql.*;
import java.util.*;
public class SeleniumTest3 {
	public static String getCurrentData() {
		SimpleDateFormat sdf = new SimpleDateFormat("yyyy.MM.dd HH:mm:ss");
		return sdf.format(new Date());
	}

	public static void main(String[] args) throws ClientProtocolException, IOException, ClassNotFoundException{
		
		String sql = "";
		PreparedStatement pstmt;
		ResultSet rs;		
		
		Class.forName("org.gjt.mm.mysql.Driver");		
		String dbUrl="jdbc:mysql://133.186.171.68:3306/kjh";
		String dbUser="kjh";
		String dbPass="1234";
		
		System.out.println("Start Date : "+ getCurrentData());
		String url = "http://finance.naver.com/item/coinfo.nhn?code=045510&target=finsum_more";
		StringBuffer sb = new StringBuffer();
		ArrayList<String> list = new ArrayList<String>();
		Connection conn = Jsoup.connect(url);
		Document html = conn.get();
		
		Elements prices = html.getElementsByClass("rate_info");

		for(Element price : prices) {
			Elements priceInfo = price.getElementsByClass("today");
			for(Element pNums : priceInfo) {
				Elements pTexts = pNums.getElementsByClass("no_today");
				for(Element pText : pTexts) {
					Elements pNum = pText.select(".no_down span");
					for(Element p : pNum) {
						list.add(p.getElementsByClass("blind").text());
					}
				}
			}
		}
		sb.append("\n");
		
		for(Element price2 : prices) {
			Elements priceInfo = price2.getElementsByClass("no_info");
			for(Element pNums : priceInfo) {
				Elements pTexts = pNums.getElementsByTag("tbody");
				for(Element pText : pTexts) {
					Elements pNum = pText.getElementsByTag("tr");
					for(Element p : pNum) {
						Elements result = p.getElementsByTag("td").select("span");
						for(Element resultText : result) {
							String texts = resultText.getElementsByClass("blind").text();
							//System.out.println(texts);
							if(texts.matches(".*[0-9]+.*")){
//								if(!texts.matches(".*[가-힣]+.*")) {
								list.add(texts+"\n");	
//								}
							} else {
								continue;
							}
						}
					}
				}
			}
		}
		
		try {
			java.sql.Connection con = DriverManager.getConnection(dbUrl, dbUser, dbPass);
			sql = "insert into TEMP1 values (?,?,?,?,?,?,?)";

			pstmt = con.prepareStatement(sql);
			pstmt.setString(1, list.get(0));
			pstmt.setString(2, list.get(1));
			pstmt.setString(3, list.get(2));
			pstmt.setString(4, list.get(3));
			pstmt.setString(5, list.get(4));
			pstmt.setString(6, list.get(5));
			pstmt.setString(7, list.get(6));
			pstmt.executeUpdate();
		}catch (SQLException e){
			e.printStackTrace();
		}
				
		System.out.println("End Date : "+getCurrentData());
	}
}

# https://downloads.mariadb.com/Connectors/java/connector-java-2.7.3/ 참고
